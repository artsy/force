version: 2.1

orbs:
  codecov: codecov/codecov@1.1.1
  hokusai: artsy/hokusai@0.7.5
  horizon: artsy/release@0.0.1
  node: artsy/node@1.0.0
  yarn: artsy/yarn@5.1.3
  artsy-remote-docker: artsy/remote-docker@dev:612b35f7058aed43d189438a46cdeee8

jobs:
  mocha:
    executor: hokusai/deploy
    steps:
      - hokusai/setup-docker
      - run: hokusai registry pull --tag "$CIRCLE_SHA1"
      - run: docker run --rm -e NODE_ENV=test --entrypoint /bin/bash "hokusai_force" /usr/local/bin/yarn test:mocha

  jest:
    executor: hokusai/deploy
    steps:
      - hokusai/setup-docker
      - run: hokusai registry pull --tag "$CIRCLE_SHA1"
      - run: docker run --rm -e NODE_ENV=test --entrypoint /bin/bash "hokusai_force" /usr/local/bin/yarn test:jest

  type-check:
    executor: hokusai/deploy
    steps:
      - hokusai/setup-docker
      - run: hokusai registry pull --tag "$CIRCLE_SHA1"
      - run: docker run --rm -e NODE_ENV=test --entrypoint /bin/bash "hokusai_force" /usr/local/bin/yarn type-check

  acceptance:
    executor: hokusai/deploy
    steps:
      - hokusai/setup-docker
      - run: hokusai registry pull --tag "$CIRCLE_SHA1"
      - run: docker build -t electron-runner -f electron.Dockerfile .
      - run: docker run --rm --entrypoint /app/scripts/xvfb-run.sh electron-runner /usr/local/bin/yarn test:acceptance

  acceptance-cypress:
    executor: hokusai/deploy
    steps:
      - hokusai/setup-docker
      - run: hokusai registry pull --tag "$CIRCLE_SHA1"
      - run: docker build -t electron-runner -f electron.Dockerfile .
      - run: docker run --rm --entrypoint /app/scripts/xvfb-run.sh electron-runner /usr/local/bin/yarn test:smoke

not_staging_or_release: &not_staging_or_release
  filters:
    branches:
      ignore:
        - staging
        - release

workflows:
  build-deploy:
    jobs:
      - artsy-remote-docker/build:
          <<: *not_staging_or_release
          context: hokusai
          name: build
          pre-steps:
            - run:
                command: echo 'export BUILD_TARGET="builder"; export DOCKER_BUILDKIT=1; export BUILDKIT_PROGRESS=plain; export COMPOSE_DOCKER_CLI_BUILD=1;' >> $BASH_ENV

      - mocha:
          <<: *not_staging_or_release
          context: hokusai
          requires:
            - build

      - jest:
          <<: *not_staging_or_release
          context: hokusai
          requires:
            - build

      - type-check:
          <<: *not_staging_or_release
          context: hokusai
          requires:
            - build

      - acceptance:
          <<: *not_staging_or_release
          context: hokusai
          requires:
            - build

      - acceptance-cypress:
          <<: *not_staging_or_release
          context: hokusai
          requires:
            - build

      - artsy-remote-docker/build:
          <<: *not_staging_or_release
          context: hokusai
          name: push-staging-image
          requires:
            - mocha
            - jest
            - type-check
            - acceptance
            - acceptance-cypress
          pre-steps:
            - run:
                command: echo 'export BUILD_TARGET="production"' >> $BASH_ENV
